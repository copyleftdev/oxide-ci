# Secrets Management Schemas
# Defines secret references and injection patterns

SecretReference:
  type: object
  required:
    - name
    - source
  properties:
    name:
      type: string
      description: Environment variable name to inject as
      examples:
        - "AWS_ACCESS_KEY_ID"
        - "NPM_TOKEN"
    source:
      $ref: '#/SecretSource'
    key:
      type: string
      description: Key within the secret (for structured secrets)
    masked:
      type: boolean
      default: true
      description: Mask value in logs
    required:
      type: boolean
      default: true
      description: Fail if secret is not found

SecretSource:
  type: object
  required:
    - provider
  properties:
    provider:
      type: string
      enum:
        - oxide
        - vault
        - aws_ssm
        - aws_secrets_manager
        - gcp_secret_manager
        - azure_keyvault
        - environment
      description: Secret provider
    path:
      type: string
      description: Provider-specific secret path
      examples:
        - "secret/data/ci/npm"
        - "/oxide-ci/prod/api-key"
    version:
      type: string
      description: Secret version (if supported)

OxideSecret:
  type: object
  required:
    - id
    - name
    - scope
  properties:
    id:
      $ref: './common.yaml#/Uuid'
    name:
      type: string
      description: Secret name (unique within scope)
    scope:
      type: string
      enum:
        - organization
        - project
        - pipeline
        - environment
    environment:
      type: string
      description: Environment name (e.g., "production", "staging")
    created_at:
      $ref: './common.yaml#/Timestamp'
    updated_at:
      $ref: './common.yaml#/Timestamp'
    expires_at:
      $ref: './common.yaml#/Timestamp'
    created_by:
      type: string
      description: User who created the secret
    last_used_at:
      $ref: './common.yaml#/Timestamp'
    version:
      type: integer
      description: Secret version number

VaultConfig:
  type: object
  required:
    - address
  properties:
    address:
      type: string
      format: uri
      description: Vault server address
      examples:
        - "https://vault.example.com:8200"
    namespace:
      type: string
      description: Vault namespace
    auth_method:
      type: string
      enum:
        - jwt
        - approle
        - kubernetes
        - token
      default: jwt
    role:
      type: string
      description: Vault role name
    mount_path:
      type: string
      default: "secret"
      description: Secrets engine mount path

AWSSecretsConfig:
  type: object
  properties:
    region:
      type: string
      description: AWS region
      examples:
        - "us-east-1"
    role_arn:
      type: string
      description: IAM role ARN to assume
    use_oidc:
      type: boolean
      default: true
      description: Use OIDC for authentication

GCPSecretsConfig:
  type: object
  properties:
    project_id:
      type: string
      description: GCP project ID
    use_workload_identity:
      type: boolean
      default: true
      description: Use Workload Identity Federation

AzureKeyVaultConfig:
  type: object
  required:
    - vault_url
  properties:
    vault_url:
      type: string
      format: uri
      description: Key Vault URL
      examples:
        - "https://my-vault.vault.azure.net"
    tenant_id:
      type: string
    client_id:
      type: string
    use_managed_identity:
      type: boolean
      default: true

SecretAccessedPayload:
  type: object
  required:
    - secret_id
    - run_id
    - accessed_at
  properties:
    secret_id:
      $ref: './common.yaml#/Uuid'
    secret_name:
      type: string
    run_id:
      $ref: './common.yaml#/Uuid'
    step_id:
      type: string
    pipeline_id:
      $ref: './common.yaml#/Uuid'
    provider:
      type: string
    accessed_at:
      $ref: './common.yaml#/Timestamp'

SecretRotatedPayload:
  type: object
  required:
    - secret_id
    - old_version
    - new_version
    - rotated_at
  properties:
    secret_id:
      $ref: './common.yaml#/Uuid'
    secret_name:
      type: string
    old_version:
      type: integer
    new_version:
      type: integer
    rotated_by:
      type: string
    rotated_at:
      $ref: './common.yaml#/Timestamp'
